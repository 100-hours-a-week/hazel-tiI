## 날짜: 2025-01-21
## 커뮤니티 

### sameSite 문제 및 해결과정 



<br>

### 문제 상황 
로컬 환경에서는 정상 동작 하지만 EC2 환경에서는 쿠키가 전달되지 않아 로그인이 유지되지 않았다.
로그인에 성공 하더라도 게시글 목록 페이지로 이동하면 세션 쿠키가 없기 때문에 로그인 페이지로 리다이렉트가 됐다. 
결론적으로 로그인에 성공했음에도 세션 유지가 되지 않아 페이지로의 접근이 불가능한 상황인 것이다. 


<br>


### 문제 해결을 위한 시도 
1. 환경 변수 문제 
- `prod`와 `dev` 환경 변수를 분리하는 과정에서 발생한 문제일 것이라 생각했다. 
- 하지만 여러 시도를 통해 환경 변수와는 무관하다는 것을 확인하였다. 
2. 세션 미들웨어 설정 확인
- 세션 설정(`Credentials`, `httpOnly`, `secure`)을 확인 했지만 설정의 이상은 없었다. 
3. sameSite 문제 확인 
- 비슷한 문제를 경험한 사례를 참고하던 중 `sameSite` 문제일 가능성을 확인하였다. 
- 사례에 따라 `sameSite: 'lax'`로 설정하였으나 해결되지 않았다.  


<br>


### sameSite란? 
브라우저의 보안 정책 중 하나로 쿠키가 전송될 수 있는 범위를 제한하는 것이다. 
주로 크로스사이트 요청에서 쿠키 전송을 제한해서 CSRF와 같은 보안 취역점을 방지 하는 것이다.
- sameSte 범위 : 예를 들어 `fe.o.kr`과 `be.o.kr`은 같은 사이트로 간주하지만 IP주소 간 요청(`43.203.88.32` `43.203.156.32`)은 다른 
사이트로 간주한다. 
- CSRF : 신뢰할 수 있는 사용자를 사칭해 웹 사이트에 원하지 않는 명령을 보내는 공격이다. 

<br>

### sameSite가 적용된 이유
- CSRF 공격 방지 : 크롬과 같은 최신 브라우저에선 보안 강화를 위해 기본 정책을 `sameSite: lax`로 변경하였다. 
- 과거엔 기본 설정값이 `none`이었으나 `lax`로 변경 되었다. 


<br>

### sameSite 옵션
1. strict 
- 가장 보수적인 정책
- 크로스사이트 요청에서는 쿠키 전송이 불가능함
2. lax
- strict에 비해 느슨한 정책
- 크로스사이트 요청에는 제한 되지만 GET 요청은 허용함 
3. none
- 크로스사이트 요청에도 쿠키를 항상 전송함
- Secure 옵션을 필수로 적용해야 함 
- HTTPS 환경에서만 작동함 

<br>


### 내 프로젝트 상황 
- EC2 2개를 사용하여 프론트엔드와 백엔드를 각각 배포 하였다. 두 서버가 다른 IP 주소를 사용하기 때문에 브라우저는 이를 크로스사이트 요청으로 간주한다. 
- sameSite 설정을 `lax`로 변경해 보았으나 쿠키가 전달되지 않았다. HTTPS가 설정되지 않았기 때문에 
`sameSite: none`은 동작하지 않는다. 

<br>


### 해결 과정
1. 도메인 연결
- 프론트엔드와 백엔드가 같은 도메인 아래 있다면 크로스사이트 요청이 아니라고 간주될 것이다. 
- 프론트엔드와 백엔드 모두에 같은 사이트 도메인을 적용한다. 
2. 결과 
- 도메인을 적용한 후 쿠키가 정상적으로 전달되었다. 
- 로그인 후 게시글 목록 페이지로 정상 이동하는 것을 확인하였다.  


<br>


### 오늘의 회고
- 이번 문제처럼 단순히 코드 수정으로 해결되지 않는 상황에서는 배포 환경을 구성할 때 
브라우저 별 동작의 차이와 추가적인 요구 사항 등을 꼼꼼하게 고려해야 한다는 것을 배웠다. 
- 문제 상황을 팀과 공유하며 다양한 의견과 조언을 얻을 수 있었고 
이를 통해 불필요한 시도를 줄이고 문제를 빠르게 해결할 수 있었다.



<br>

[참고]
- https://velog.io/@wjd15sheep/SameSite
- https://seob.dev/posts/%EB%B8%8C%EB%9D%BC%EC%9A%B0%EC%A0%80-%EC%BF%A0%ED%82%A4%EC%99%80-SameSite-%EC%86%8D%EC%84%B1/